{% import 'macros/form.html' as form %}

{% set method_options = h.dimred_allowed_methods_options() %}
{% set method_value = data.get('method', resource_view.method) if resource_view else data.get('method') %}
{% set render_backend_value = data.get('render_backend', resource_view.render_backend) if resource_view else data.get('render_backend') %}
{% if not render_backend_value %}
    {% set render_backend_value = h.dimred_render_backend_default() %}
{% endif %}

{% block view_form_filters %}{% endblock %}

<div class="form-group control-group">
    {{ form.select(
        'method',
        id='field-method',
        label=_('Dimensionality reduction method'),
        options=method_options,
        selected=method_value or h.dimred_default_method(),
        classes=['control-full']
    ) }}
</div>

{% set color_value = data.get('color_by', resource_view.color_by) if resource_view else data.get('color_by') %}
{% set color_options = h.dimred_color_options_from_resource(resource, resource_view) %}
{% set feature_options = h.dimred_feature_options_from_resource(resource, resource_view) %}
{% set method_for_defaults = method_value or h.dimred_default_method() %}
{% set default_params = h.dimred_method_default_params(method_for_defaults) %}
{% set defaults_map = h.dimred_methods_defaults() %}
{% set params_value = data.get('method_params', resource_view.method_params) if resource_view else data.get('method_params') %}
{% if params_value is mapping %}
    {% set params_value = h.dump_json(params_value, indent=2) %}
{% endif %}
{% if not params_value %}
    {% set params_value = h.dump_json(default_params) %}
{% endif %}
{% set selected_features = data.get('feature_columns', resource_view.feature_columns) if resource_view else data.get('feature_columns') %}
{% if selected_features is string %}
    {% set selected_features = selected_features.split(',') %}
{% endif %}
{% if not selected_features %}
    {% set selected_features = feature_options | map(attribute='value') | list %}
{% endif %}

{% if feature_options %}
    <div class="form-group control-group">
        <label class="form-label">{{ _('Feature columns') }}</label>
        <div class="controls" id="feature-columns-list">
            {% for opt in feature_options %}
                <div class="checkbox">
                    <label class="dimred-feature-label"
                           for="field-feature-{{ loop.index }}">
                        <input
                                id="field-feature-{{ loop.index }}"
                                type="checkbox"
                                name="feature_columns"
                                value="{{ opt.value }}"
                                {% if opt.value in selected_features %}checked{% endif %}
                        />
                        {{ opt.text }}
                    </label>
                </div>
            {% endfor %}
        </div>
    </div>
{% endif %}

<div class="form-group control-group">
    {{ form.select(
        'color_by',
        id='field-color_by',
        label=_('Color by column'),
        options=color_options,
        selected=color_value,
        classes=['control-full']
    ) }}
</div>

<div class="form-group control-group">
    {{ form.textarea(
        'method_params',
        id='field-method-params',
        label=_('Method parameters (JSON)'),
        value=params_value,
        placeholder='',
        classes=['control-full'],
        attrs={
            'data-module': 'dimred-view-form',
            'data-module-defaults': h.dump_json(defaults_map)
        },
        rows=10
    ) }}
</div>

<div class="form-group control-group">
    {{ form.select(
        'render_backend',
        id='field-render-backend',
        label=_('Render backend'),
        options=h.dimred_render_backend_options(),
        selected=render_backend_value,
        classes=['control-full']
    ) }}
</div>

{% asset 'dimred/dimred-js' %}
{% asset 'dimred/dimred-css' %}
